###########################################################################
# 
#  Copyright 2019 Google Inc.
#
#  Licensed under the Apache License, Version 2.0 (the "License");
#  you may not use this file except in compliance with the License.
#  You may obtain a copy of the License at
#
#      https://www.apache.org/licenses/LICENSE-2.0
#
#  Unless required by applicable law or agreed to in writing, software
#  distributed under the License is distributed on an "AS IS" BASIS,
#  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
#  See the License for the specific language governing permissions and
#  limitations under the License.
#
###########################################################################

'''
Browser Activity Dashboard

Visualizes a client's Campaign Manager and DV360 activity by browser and device

W
a
i
t
 
f
o
r
 
<
b
>
B
i
g
Q
u
e
r
y
-
>
S
t
a
r
T
h
i
n
k
e
r
 
D
a
t
a
-
>
U
N
D
E
F
I
N
E
D
-
>
*
<
/
b
>
 
t
o
 
b
e
 
c
r
e
a
t
e
d
.


J
o
i
n
 
t
h
e
 
<
a
 
h
r
e
=
'
h
t
t
p
s
:
/
/
g
r
o
u
p
s
.
g
o
o
g
l
e
.
c
o
m
/
d
/
f
o
r
u
m
/
s
t
a
r
t
h
i
n
k
e
r
-
a
s
s
e
t
s
'
 
t
a
r
g
e
t
=
'
_
b
l
a
n
k
'
>
S
t
a
r
T
h
i
n
k
e
r
 
A
s
s
e
t
s
 
G
r
o
u
p
<
/
a
>
 
t
o
 
a
c
c
e
s
s
 
t
h
e
 
f
o
l
l
o
w
i
n
g
 
a
s
s
e
t
s


F
o
r
 
e
a
c
h
 
o
f
 
t
h
e
 
f
o
l
l
o
w
i
n
g
 
c
o
p
y
 
a
n
d
 
c
o
n
n
e
c
t
 
t
o
 
t
h
e
 
n
e
w
 
B
i
g
Q
u
e
r
y
 
s
o
u
r
c
e
s
 
a
b
o
v
e
.
 
S
e
e
 
<
a
 
h
r
e
f
=
'
h
t
t
p
s
:
/
/
d
o
c
s
.
g
o
o
g
l
e
.
c
o
m
/
d
o
c
u
m
e
n
t
/
d
/
1
1
N
l
V
W
z
b
w
6
U
e
S
U
V
U
e
N
u
E
R
Z
G
U
9
F
Y
y
S
W
c
R
b
u
2
F
g
6
z
J
4
O
-
A
/
e
d
i
t
?
u
s
p
=
s
h
a
r
i
n
g
'
 
t
a
r
g
e
t
=
'
_
b
l
a
n
k
'
>
d
e
t
a
i
l
e
d
 
i
n
s
t
r
u
c
t
i
o
n
s
<
/
a
>
.


C
o
p
y
 
<
a
 
h
r
e
f
=
'
h
t
t
p
s
:
/
/
d
a
t
a
s
t
u
d
i
o
.
g
o
o
g
l
e
.
c
o
m
/
o
p
e
n
/
1
l
x
R
W
I
s
3
o
z
z
W
s
4
-
9
W
T
y
3
E
c
q
M
c
r
t
Y
n
-
7
n
I
'
 
t
a
r
g
e
t
=
'
_
b
l
a
n
k
'
>
C
o
m
b
i
n
e
d
_
B
r
o
w
s
e
r
_
D
e
l
i
v
e
r
y
<
/
a
>
.


C
o
p
y
 
<
a
 
h
r
e
f
=
'
h
t
t
p
s
:
/
/
d
a
t
a
s
t
u
d
i
o
.
g
o
o
g
l
e
.
c
o
m
/
o
p
e
n
/
1
C
e
O
H
x
x
o
-
y
A
A
M
W
c
j
I
1
A
L
s
u
_
D
v
-
u
2
W
7
8
R
k
'
 
t
a
r
g
e
t
=
'
_
b
l
a
n
k
'
>
D
V
3
6
0
_
B
r
o
w
s
e
r
_
D
e
l
i
v
e
r
y
<
/
a
>
.


C
o
p
y
 
<
a
 
h
r
e
f
=
'
h
t
t
p
s
:
/
/
d
a
t
a
s
t
u
d
i
o
.
g
o
o
g
l
e
.
c
o
m
/
o
p
e
n
/
1
N
l
N
8
r
e
l
-
-
3
t
9
V
t
T
u
A
_
0
y
2
c
6
d
c
m
I
Y
o
g
5
g
'
 
t
a
r
g
e
t
=
'
_
b
l
a
n
k
'
>
C
M
_
B
r
o
w
s
e
r
_
D
e
l
i
v
e
r
y
<
/
a
>
.


C
o
p
y
 
<
a
 
h
r
e
f
=
'
h
t
t
p
s
:
/
/
d
a
t
a
s
t
u
d
i
o
.
g
o
o
g
l
e
.
c
o
m
/
o
p
e
n
/
1
-
m
G
W
7
4
g
n
W
u
8
z
K
e
j
B
h
f
L
v
m
g
r
o
5
r
l
p
V
N
k
E
'
 
t
a
r
g
e
t
=
'
_
b
l
a
n
k
'
>
F
l
o
o
d
l
i
g
h
t
_
B
r
o
w
s
e
r
_
D
e
l
i
v
e
r
y
<
/
a
>
.


C
o
p
y
 
<
a
 
h
r
e
f
=
'
h
t
t
p
s
:
/
/
d
a
t
a
s
t
u
d
i
o
.
g
o
o
g
l
e
.
c
o
m
/
o
p
e
n
/
1
f
t
G
T
V
0
j
a
H
K
w
G
e
m
h
S
g
K
O
c
o
e
s
u
W
z
f
4
J
c
w
d
'
 
t
a
r
g
e
t
=
'
_
b
l
a
n
k
'
>
B
r
o
w
s
e
r
 
D
e
l
i
v
e
r
y
 
R
e
p
o
r
t
<
/
a
>
.


W
h
e
n
 
p
r
o
m
p
t
e
d
 
c
h
o
o
s
e
 
t
h
e
 
n
e
w
 
d
a
t
a
 
s
o
u
r
c
e
s
 
y
o
u
 
j
u
s
t
 
c
r
e
a
t
e
d
.


O
r
 
g
i
v
e
 
t
h
e
s
e
 
i
n
t
r
u
c
t
i
o
n
s
 
t
o
 
t
h
e
 
c
l
i
e
n
t
.

'''

from starthinker_airflow.factory import DAG_Factory
 
USER_CONN_ID = "google_cloud_default" # The connection to use for user authentication.
GCP_CONN_ID = "" # The connection to use for service authentication.

INPUTS = {
  'dataset': '',  # Place where tables will be written in BigQuery.
  'dcm_account': '',  # DCM account id of client.
  'dcm_advertisers': '',  # Comma delimited list of DCM advertiser ids.
  'dcm_floodlight': '',  # DCM floodlight configuration id.
  'dbm_partner': '',  # DBM partner id.
  'dbm_advertisers': '',  # Comma delimited list of DBM advertiser ids.
}

TASKS = [
  {
    'dataset': {
      'auth': 'service',
      'dataset': {
        'field': {
          'name': 'dataset',
          'kind': 'string',
          'order': 1,
          'default': '',
          'description': 'Report suffix and BigQuery dataset to contain data.'
        }
      }
    }
  },
  {
    'dcm': {
      'auth': 'user',
      'report': {
        'account': {
          'field': {
            'name': 'dcm_account',
            'kind': 'integer',
            'order': 2,
            'default': '',
            'description': 'DCM account id of client.'
          }
        },
        'filters': {
          'dfa:advertiser': {
            'values': {
              'field': {
                'name': 'dcm_advertisers',
                'kind': 'integer_list',
                'order': 3,
                'default': '',
                'description': 'Comma delimited list of DCM advertiser ids.'
              }
            }
          }
        },
        'body': {
          'type': 'STANDARD',
          'format': 'CSV',
          'name': {
            'field': {
              'name': 'dataset',
              'kind': 'string',
              'prefix': 'CM_Browser_Delivery_',
              'description': 'Report in DCM, should be unique.'
            }
          },
          'accountId': {
            'field': {
              'name': 'dcm_account',
              'kind': 'integer',
              'order': 2,
              'default': '',
              'description': 'DCM account id of client.'
            }
          },
          'criteria': {
            'dateRange': {
              'relativeDateRange': 'LAST_365_DAYS'
            },
            'dimensions': [
              {
                'kind': 'dfareporting#sortedDimension',
                'name': 'dfa:advertiser'
              },
              {
                'kind': 'dfareporting#sortedDimension',
                'name': 'dfa:advertiserId'
              },
              {
                'kind': 'dfareporting#sortedDimension',
                'name': 'dfa:campaign'
              },
              {
                'kind': 'dfareporting#sortedDimension',
                'name': 'dfa:campaignId'
              },
              {
                'kind': 'dfareporting#sortedDimension',
                'name': 'dfa:site'
              },
              {
                'kind': 'dfareporting#sortedDimension',
                'name': 'dfa:browserPlatform'
              },
              {
                'kind': 'dfareporting#sortedDimension',
                'name': 'dfa:platformType'
              },
              {
                'kind': 'dfareporting#sortedDimension',
                'name': 'dfa:date'
              }
            ],
            'metricNames': [
              'dfa:impressions',
              'dfa:clicks',
              'dfa:activityViewThroughConversions',
              'dfa:activityClickThroughConversions'
            ]
          }
        }
      }
    }
  },
  {
    'dcm': {
      'auth': 'user',
      'report': {
        'account': {
          'field': {
            'name': 'dcm_account',
            'kind': 'integer',
            'order': 2,
            'default': '',
            'description': 'DCM account id of client.'
          }
        },
        'name': {
          'field': {
            'name': 'dataset',
            'kind': 'string',
            'prefix': 'CM_Browser_Delivery_',
            'description': 'Report in DCM, should be unique.'
          }
        }
      },
      'out': {
        'bigquery': {
          'table': 'CM_Browser_Delivery',
          'dataset': {
            'field': {
              'name': 'dataset',
              'kind': 'string',
              'order': 1,
              'default': '',
              'description': 'BigQuery dataset to contain data.'
            }
          }
        }
      }
    }
  },
  {
    'dcm': {
      'auth': 'user',
      'report': {
        'account': {
          'field': {
            'name': 'dcm_account',
            'kind': 'integer',
            'order': 2,
            'default': '',
            'description': 'DCM account id of client.'
          }
        },
        'body': {
          'name': {
            'field': {
              'name': 'dataset',
              'kind': 'string',
              'prefix': 'CM_Browser_Floodlight_',
              'description': 'Report in DCM, should be unique.'
            }
          },
          'type': 'FLOODLIGHT',
          'format': 'CSV',
          'accountId': {
            'field': {
              'name': 'dcm_account',
              'kind': 'integer',
              'order': 2,
              'default': '',
              'description': 'DCM account id of client.'
            }
          },
          'floodlightCriteria': {
            'dateRange': {
              'relativeDateRange': 'LAST_60_DAYS'
            },
            'dimensions': [
              {
                'kind': 'dfareporting#sortedDimension',
                'name': 'dfa:advertiser'
              },
              {
                'kind': 'dfareporting#sortedDimension',
                'name': 'dfa:advertiserId'
              },
              {
                'kind': 'dfareporting#sortedDimension',
                'name': 'dfa:campaign'
              },
              {
                'kind': 'dfareporting#sortedDimension',
                'name': 'dfa:campaignId'
              },
              {
                'kind': 'dfareporting#sortedDimension',
                'name': 'dfa:date'
              },
              {
                'kind': 'dfareporting#sortedDimension',
                'name': 'dfa:browserPlatform'
              },
              {
                'kind': 'dfareporting#sortedDimension',
                'name': 'dfa:platformType'
              },
              {
                'kind': 'dfareporting#sortedDimension',
                'name': 'dfa:activity'
              },
              {
                'kind': 'dfareporting#sortedDimension',
                'name': 'dfa:activityId'
              }
            ],
            'floodlightConfigId': {
              'dimensionName': 'dfa:floodlightConfigId',
              'kind': 'dfareporting#dimensionValue',
              'matchType': 'EXACT',
              'value': {
                'field': {
                  'name': 'dcm_floodlight',
                  'kind': 'integer',
                  'order': 4,
                  'default': '',
                  'description': 'DCM floodlight configuration id.'
                }
              }
            },
            'metricNames': [
              'dfa:activityClickThroughConversions',
              'dfa:activityViewThroughConversions',
              'dfa:totalConversions'
            ],
            'reportProperties': {
              'includeUnattributedCookieConversions': True,
              'includeUnattributedIPConversions': False
            }
          }
        }
      }
    }
  },
  {
    'dcm': {
      'auth': 'user',
      'report': {
        'account': {
          'field': {
            'name': 'dcm_account',
            'kind': 'integer',
            'order': 2,
            'default': '',
            'description': 'DCM account id of client.'
          }
        },
        'name': {
          'field': {
            'name': 'dataset',
            'kind': 'string',
            'prefix': 'CM_Browser_Floodlight_',
            'description': 'Report in DCM, should be unique.'
          }
        }
      },
      'out': {
        'bigquery': {
          'table': 'CM_Browser_Floodlight',
          'dataset': {
            'field': {
              'name': 'dataset',
              'kind': 'string',
              'order': 1,
              'default': '',
              'description': 'BigQuery dataset to contain data.'
            }
          }
        }
      }
    }
  },
  {
    'dbm': {
      'auth': 'user',
      'report': {
        'name': {
          'field': {
            'name': 'dataset',
            'kind': 'string',
            'prefix': 'DV360_Browser_Delivery_',
            'description': 'DBM report name, should be unique.'
          }
        },
        'body': {
          'timezoneCode': 'America/Los_Angeles',
          'metadata': {
            'title': {
              'field': {
                'name': 'dataset',
                'kind': 'string',
                'prefix': 'DV360_Browser_Delivery_',
                'description': 'Name of report in DBM, should be unique.'
              }
            },
            'dataRange': 'LAST_365_DAYS'
          },
          'params': {
            'type': 'TYPE_GENERAL',
            'includeInviteData': True,
            'filters': [
              {
                'type': 'FILTER_PARTNER',
                'value': {
                  'field': {
                    'name': 'dbm_partner',
                    'kind': 'integer',
                    'order': 5,
                    'default': '',
                    'description': 'DBM partner id.'
                  }
                }
              },
              {
                'type': 'FILTER_ADVERTISER',
                'value': {
                  'field': {
                    'name': 'dbm_advertisers',
                    'kind': 'integer_list',
                    'order': 6,
                    'default': '',
                    'description': 'Comma delimited list of DBM advertiser ids.'
                  }
                }
              }
            ],
            'groupBys': [
              'FILTER_ADVERTISER',
              'FILTER_BROWSER',
              'FILTER_MEDIA_PLAN',
              'FILTER_DATE',
              'FILTER_DEVICE_TYPE',
              'FILTER_INSERTION_ORDER',
              'FILTER_PAGE_LAYOUT'
            ],
            'metrics': [
              'METRIC_IMPRESSIONS',
              'METRIC_CLICKS',
              'METRIC_LAST_CLICKS',
              'METRIC_LAST_IMPRESSIONS',
              'METRIC_REVENUE_ADVERTISER',
              'METRIC_MEDIA_COST_ADVERTISER'
            ]
          }
        }
      }
    }
  },
  {
    'dbm': {
      'auth': 'user',
      'datastudio': True,
      'report': {
        'name': {
          'field': {
            'name': 'dataset',
            'kind': 'string',
            'prefix': 'DV360_Browser_Delivery_',
            'description': 'DBM report name, should be unique.'
          }
        }
      },
      'out': {
        'bigquery': {
          'table': 'DV360_Browser_Delivery',
          'dataset': {
            'field': {
              'name': 'dataset',
              'kind': 'string',
              'order': 1,
              'default': '',
              'description': 'BigQuery dataset to contain data.'
            }
          },
          'schema': [
            {
              'name': 'Advertiser',
              'type': 'STRING'
            },
            {
              'name': 'Advertiser_ID',
              'type': 'INTEGER'
            },
            {
              'name': 'Advertiser_Status',
              'type': 'STRING'
            },
            {
              'name': 'Advertiser_Integration_Code',
              'type': 'STRING'
            },
            {
              'name': 'Browser',
              'type': 'STRING'
            },
            {
              'name': 'Campaign',
              'type': 'STRING'
            },
            {
              'name': 'Campaign_ID',
              'type': 'INTEGER'
            },
            {
              'name': 'Report_Day',
              'type': 'DATE'
            },
            {
              'name': 'Device_Type',
              'type': 'STRING'
            },
            {
              'name': 'Insertion_Order',
              'type': 'STRING'
            },
            {
              'name': 'Insertion_Order_ID',
              'type': 'INTEGER'
            },
            {
              'name': 'Insertion_Order_Status',
              'type': 'STRING'
            },
            {
              'name': 'Insertion_Order_Integration_Code',
              'type': 'STRING'
            },
            {
              'name': 'Environment',
              'type': 'STRING'
            },
            {
              'name': 'Advertiser_Currency',
              'type': 'STRING'
            },
            {
              'name': 'Impressions',
              'type': 'INTEGER'
            },
            {
              'name': 'Clicks',
              'type': 'INTEGER'
            },
            {
              'name': 'Post_Click_Conversions',
              'type': 'FLOAT'
            },
            {
              'name': 'Post_View_Conversions',
              'type': 'FLOAT'
            },
            {
              'name': 'Revenue_Adv_Currency',
              'type': 'FLOAT'
            },
            {
              'name': 'Media_Cost_Advertiser_Currency',
              'type': 'FLOAT'
            }
          ]
        }
      }
    }
  },
  {
    'bigquery': {
      'auth': 'service',
      'to': {
        'table': 'Floodlight_Browser_Delivery',
        'dataset': {
          'field': {
            'name': 'dataset',
            'kind': 'string',
            'order': 1,
            'default': '',
            'description': 'BigQuery dataset to contain data.'
          }
        }
      },
      'from': {
        'query': 'WITH\r\nbrowser_clean AS (\r\n  SELECT\r\n    Advertiser,\r\n    Advertiser_Id,\r\n    Campaign,\r\n    Campaign_Id,\r\n    Browser_Platform,\r\n   Activity,\r\n    Activity_ID,\r\n    CASE\r\n    WHEN REGEXP_CONTAINS(Browser_Platform, "((?i).*Chrome).*") THEN "Chrome" \r\n    WHEN REGEXP_CONTAINS(Browser_Platform, "((?i).*Firefox).*") THEN "Firefox" \r\n    WHEN REGEXP_CONTAINS(Browser_Platform, "((?i).*Safari).*") THEN "Safari"\r\n    WHEN REGEXP_CONTAINS(Browser_Platform, "((?i).*iPad).*") THEN "Safari" \r\n    WHEN REGEXP_CONTAINS(Browser_Platform, "((?i).*iPad).*") THEN "Safari" \r\n    WHEN REGEXP_CONTAINS(Browser_Platform, "((?i).*iPhone).*") THEN "Safari" \r\n    ELSE "Other"\r\n    END AS Clean_Browser,\r\n    Platform_Type,\r\n    Report_Day,\r\n    View_Through_Conversions,\r\n    Click_Through_Conversions,\r\n    Total_Conversions\r\n  FROM [PARAMETER].CM_Browser_Floodlight\r\n)\r\n\r\n  SELECT\r\n    *,\r\n    CASE WHEN Platform_Type="Mobile highend: smartphone" OR Platform_Type="Mobile midrange: feature phone" OR Platform_Type="Tablet" THEN Total_Conversions ELSE 0 END AS Mobile_Convs,\r\n   CASE WHEN Platform_Type="Desktop" THEN Total_Conversions ELSE 0 END AS Desktop_Convs,\r\n   CASE WHEN Clean_Browser="Chrome" THEN Total_Conversions ELSE 0 END AS Chrome_Convs,\r\n   CASE WHEN Clean_Browser="Safari" THEN Total_Conversions ELSE 0 END AS Safari_Convs,\r\n   CASE WHEN Clean_Browser="Firefox" THEN Total_Conversions ELSE 0 END AS Firefox_Convs\r\n  FROM browser_clean',
        'legacy': False,
        'parameters': [
          {
            'field': {
              'name': 'dataset',
              'kind': 'string',
              'description': 'Bigquery container for data.'
            }
          }
        ]
      }
    }
  },
  {
    'bigquery': {
      'auth': 'service',
      'to': {
        'table': 'CM_Browser_Delivery',
        'dataset': {
          'field': {
            'name': 'dataset',
            'kind': 'string',
            'order': 1,
            'default': '',
            'description': 'BigQuery dataset to contain data.'
          }
        }
      },
      'from': {
        'query': 'WITH\r\nbrowser_clean AS (\r\n  SELECT\r\n    Advertiser,\r\n    Advertiser_Id,\r\n    Campaign,\r\n    Campaign_Id,\r\n    Site_Dcm,\r\n    Browser_Platform,\r\n  CASE\r\n    WHEN REGEXP_CONTAINS(Browser_Platform, "((?i).*Chrome).*") THEN "Chrome" \r\n    WHEN REGEXP_CONTAINS(Browser_Platform, "((?i).*Firefox).*") THEN "Firefox" \r\n    WHEN REGEXP_CONTAINS(Browser_Platform, "((?i).*Safari).*") THEN "Safari"\r\n    WHEN REGEXP_CONTAINS(Browser_Platform, "((?i).*iPad).*") THEN "Safari" \r\n    WHEN REGEXP_CONTAINS(Browser_Platform, "((?i).*iPad).*") THEN "Safari" \r\n    WHEN REGEXP_CONTAINS(Browser_Platform, "((?i).*iPhone).*") THEN "Safari" \r\n    ELSE "Other"\r\n    END AS Clean_Browser,\r\n    Platform_Type,\r\n    Report_Day,\r\n    Impressions,\r\n    Clicks,\r\n    View_Through_Conversions,\r\n    Click_Through_Conversions\r\n  FROM [PARAMETER].CM_Browser_Delivery\r\n)\r\n\r\n SELECT\r\n    *,\r\n   CASE WHEN Platform_Type="Mobile highend: smartphone" OR Platform_Type="Mobile midrange: feature phone" OR Platform_Type="Tablet" THEN Impressions ELSE 0 END AS Mobile_Imps,\r\n   CASE WHEN Platform_Type="Desktop" THEN Impressions ELSE 0 END AS Desktop_Imps,\r\n   CASE WHEN Platform_Type="Connected TV" THEN Impressions ELSE 0 END AS CTV_Imps,\r\n   CASE WHEN Clean_Browser="Chrome" THEN Impressions ELSE 0 END AS Chrome_Imps,\r\n   CASE WHEN Clean_Browser="Safari" THEN Impressions ELSE 0 END AS Safari_Imps,\r\n   CASE WHEN Clean_Browser="Firefox" THEN Impressions ELSE 0 END AS Firefox_Imps\r\n  FROM browser_clean',
        'legacy': False,
        'parameters': [
          {
            'field': {
              'name': 'dataset',
              'kind': 'string',
              'description': 'Bigquery container for data.'
            }
          }
        ]
      }
    }
  },
  {
    'bigquery': {
      'auth': 'service',
      'to': {
        'table': 'DV360_Browser_Delivery',
        'dataset': {
          'field': {
            'name': 'dataset',
            'kind': 'string',
            'order': 1,
            'default': '',
            'description': 'BigQuery dataset to contain data.'
          }
        }
      },
      'from': {
        'query': 'WITH\r\nbrowser_cleaned AS (\r\n  SELECT \r\n    Advertiser,\r\n    Advertiser_Id,\r\n    Advertiser_Currency,\r\n    Browser,\r\n    Campaign,\r\n    Campaign_Id,\r\n    Insertion_Order, \r\n    Insertion_Order_Id,\r\n    Report_Day,\r\n    Device_Type,\r\n    Environment,\r\n    Impressions,\r\n    Clicks,\r\n    Post_Click_Conversions,\r\n    Post_View_Conversions,\r\n    Revenue_Adv_Currency as Revenue,\r\n    Media_Cost_Advertiser_Currency,\r\n    CASE\r\n      WHEN REGEXP_CONTAINS(Browser, "((?i).*Chrome).*") THEN "Chrome" \r\n      WHEN REGEXP_CONTAINS(Browser, "((?i).*Firefox).*") THEN "Firefox" \r\n      WHEN REGEXP_CONTAINS(Browser, "((?i).*Safari).*") THEN "Safari"\r\n      ELSE "Other"\r\n      END AS Clean_Browser,\r\n    CASE \r\n      WHEN Browser="Safari 12" THEN "Safari 12"\r\n      WHEN Browser="Safari 11" THEN "Safari 11"\r\n      WHEN REGEXP_CONTAINS(Browser, "((?i).*Safari).*") AND Browser!="Safari 12" AND Browser!="Safari 11" THEN "Safari 10 & Below"\r\n      ELSE "Non Safari"\r\n    END AS ITP_Affected_Browsers\r\n   FROM [PARAMETER].DV360_Browser_Delivery \r\n)\r\n\r\n  SELECT\r\n    *,\r\n    CASE WHEN Device_Type="Smart Phone" OR Device_Type="Tablet" THEN Impressions ELSE 0 END AS Mobile_Imps,\r\n   CASE WHEN Device_Type="Desktop" THEN Impressions ELSE 0 END AS Desktop_Imps,\r\n   CASE WHEN Device_Type="Connected TV" THEN Impressions ELSE 0 END AS CTV_Imps,\r\n   CASE WHEN Clean_Browser="Chrome" THEN Impressions ELSE 0 END AS Chrome_Imps,\r\n   CASE WHEN Clean_Browser="Safari" THEN Impressions ELSE 0 END AS Safari_Imps,\r\n   CASE WHEN Clean_Browser="Firefox" THEN Impressions ELSE 0 END AS Firefox_Imps,\r\n    CASE WHEN Clean_Browser="Chrome" THEN Revenue ELSE 0 END AS Chrome_Rev,\r\n   CASE WHEN Clean_Browser="Safari" THEN Revenue ELSE 0 END AS Safari_Rev,\r\n   CASE WHEN Clean_Browser="Firefox" THEN Revenue ELSE 0 END AS Firefox_Rev,\r\n   CASE WHEN Clean_Browser="Chrome" THEN Post_Click_Conversions ELSE 0 END AS Chrome_Click_Convs,\r\n   CASE WHEN Clean_Browser="Safari" THEN Post_Click_Conversions ELSE 0 END AS Safari_Click_Convs,\r\n   CASE WHEN Clean_Browser="Firefox" THEN Post_Click_Conversions ELSE 0 END AS Firefox_Click_Convs,\r\n   CASE WHEN Clean_Browser="Chrome" THEN Post_View_Conversions ELSE 0 END AS Chrome_View_Convs,\r\n   CASE WHEN Clean_Browser="Safari" THEN Post_View_Conversions ELSE 0 END AS Safari_View_Convs,\r\n   CASE WHEN Clean_Browser="Firefox" THEN Post_View_Conversions ELSE 0 END AS Firefox_View_Convs,\r\n   CASE WHEN Clean_Browser="Chrome" THEN Post_Click_Conversions+Post_View_Conversions ELSE 0 END AS Chrome_Convs,\r\n   CASE WHEN Clean_Browser="Safari" THEN Post_Click_Conversions+Post_View_Conversions ELSE 0 END AS Safari_Convs,\r\n   CASE WHEN Clean_Browser="Firefox" THEN Post_Click_Conversions+Post_View_Conversions ELSE 0 END AS Firefox_Convs,\r\n   \r\n   CASE WHEN ITP_Affected_Browsers="Safari 12" THEN Impressions ELSE 0 END AS S12_Imps,\r\n   CASE WHEN ITP_Affected_Browsers="Safari 11" THEN Impressions ELSE 0 END AS S11_Imps,\r\n   CASE WHEN ITP_Affected_Browsers="Safari 10 & Below" THEN Impressions ELSE 0 END AS S_Imps,\r\n   CASE WHEN ITP_Affected_Browsers="Non Safari" THEN Impressions ELSE 0 END AS NS_Imps,\r\n   \r\n   CASE WHEN ITP_Affected_Browsers="Safari 12" THEN Post_Click_Conversions ELSE 0 END AS S12_Click_Convs,\r\n   CASE WHEN ITP_Affected_Browsers="Safari 11" THEN Post_Click_Conversions ELSE 0 END AS S11_Click_Convs,\r\n   CASE WHEN ITP_Affected_Browsers="Safari 10 & Below" THEN Post_Click_Conversions ELSE 0 END AS S_Click_Convs,\r\n   CASE WHEN ITP_Affected_Browsers="Non Safari" THEN Post_Click_Conversions ELSE 0 END AS NS_Click_Convs,\r\n   \r\n   CASE WHEN ITP_Affected_Browsers="Safari 12" THEN Post_View_Conversions ELSE 0 END AS S12_View_Convs,\r\n   CASE WHEN ITP_Affected_Browsers="Safari 11" THEN Post_View_Conversions ELSE 0 END AS S11_View_Convs,\r\n   CASE WHEN ITP_Affected_Browsers="Safari 10 & Below" THEN Post_View_Conversions ELSE 0 END AS S_View_Convs,\r\n   CASE WHEN ITP_Affected_Browsers="Non Safari" THEN Post_View_Conversions ELSE 0 END AS NS_View_Convs,\r\n   \r\n   CASE WHEN ITP_Affected_Browsers="Safari 12" THEN Post_Click_Conversions+Post_View_Conversions ELSE 0 END AS S12_Convs,\r\n   CASE WHEN ITP_Affected_Browsers="Safari 11" THEN Post_Click_Conversions+Post_View_Conversions ELSE 0 END AS S11_Convs,\r\n   CASE WHEN ITP_Affected_Browsers="Safari 10 & Below" THEN Post_Click_Conversions+Post_View_Conversions ELSE 0 END AS S_Convs,\r\n   CASE WHEN ITP_Affected_Browsers="Non Safari" THEN Post_Click_Conversions+Post_View_Conversions ELSE 0 END AS NS_Convs\r\n   \r\n   \r\n  FROM browser_cleaned',
        'legacy': False,
        'parameters': [
          {
            'field': {
              'name': 'dataset',
              'kind': 'string',
              'description': 'Place where tables will be written in BigQuery.'
            }
          }
        ]
      }
    }
  },
  {
    'bigquery': {
      'auth': 'service',
      'to': {
        'table': 'Combined_Browser_Delivery',
        'dataset': {
          'field': {
            'name': 'dataset',
            'kind': 'string',
            'order': 1,
            'default': '',
            'description': 'BigQuery dataset to contain data.'
          }
        }
      },
      'from': {
        'query': 'WITH cm AS ( SELECT Report_Day, CASE  WHEN Platform_Type="Desktop" THEN "Desktop" WHEN Platform_Type="Tablet" THEN "Mobile_Tablet" WHEN Platform_Type="Mobile highend: smartphone" THEN "Mobile_Tablet" WHEN Platform_Type="Mobile midrange: feature phone" THEN "Mobile_Tablet" WHEN Platform_Type="Connected TV" THEN "CTV" END AS Device_Clean, SUM(Impressions) as CM_Impressions FROM `[PARAMETER].CM_Browser_Delivery`  GROUP BY 1,2 ),  dv3 AS ( SELECT Report_Day as RD, CASE  WHEN Device_Type="Desktop" THEN "Desktop" WHEN Device_Type="Tablet" THEN "Mobile_Tablet" WHEN Device_Type="Smart Phone" THEN "Mobile_Tablet" WHEN Device_Type="Connected TV" THEN "CTV" END AS Device_Clean_DV360, SUM(Impressions) as DV360_Impressions FROM `[PARAMETER].DV360_Browser_Delivery`  GROUP BY 1,2 )  SELECT Report_Day, Device_Clean, CM_Impressions, DV360_Impressions FROM cm a JOIN dv3 b ON a.Report_Day=b.RD AND a.Device_Clean=b.Device_Clean_DV360',
        'legacy': False,
        'parameters': [
          {
            'field': {
              'name': 'dataset',
              'kind': 'string',
              'description': 'Place where tables will be written in BigQuery.'
            }
          },
          {
            'field': {
              'name': 'dataset',
              'kind': 'string',
              'description': 'Place where tables will be written in BigQuery.'
            }
          }
        ]
      }
    }
  }
]

DAG_FACTORY = DAG_Factory('itp', { 'tasks':TASKS }, INPUTS)
DAG_FACTORY.apply_credentails(USER_CONN_ID, GCP_CONN_ID)
DAG = DAG_FACTORY.execute()

if __name__ == "__main__":
  DAG_FACTORY.print_commandline()
